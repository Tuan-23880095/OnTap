<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đề Kiểm Tra Công Nghệ 7 - Cuối HK1</title>
    <style>
        :root { --primary: #005a8d; --accent: #f39c12; --bg: #f3f4f6; --text: #1f2937; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding-bottom: 80px; margin: 0; }
        .container { max-width: 900px; margin: 0 auto; padding: 20px; }
        
        /* HEADER & UI */
        .card { background: #fff; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .screen { display: none; } .screen.active { display: block; }
        .badge { background: var(--accent); color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; }
        
        .header { position: fixed; top: 0; left: 0; right: 0; background: white; padding: 10px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 100; display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid var(--primary); }
        .timer { font-weight: 800; color: white; background: var(--accent); padding: 5px 15px; border-radius: 20px; }
        
        /* QUESTION STYLES */
        .option-btn { width: 100%; text-align: left; padding: 12px; border: 1px solid #ddd; margin-bottom: 8px; border-radius: 6px; cursor: pointer; background: white; }
        .option-btn:hover { border-color: var(--primary); background: #f0f9ff; }
        .option-btn.selected { background: #e0f2fe; border-color: var(--primary); color: var(--primary); font-weight: 600; }
        .option-btn.correct { background: #dcfce7; border-color: #22c55e; } .option-btn.wrong { background: #fee2e2; border-color: #ef4444; }

        .btn { background: var(--primary); color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        
        /* RESULT MODAL */
        #result-screen { text-align: center; margin-top: 60px; }
        #final-score { font-size: 3rem; color: var(--primary); margin: 10px 0; }
        #loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; text-align: center; padding-top: 20%; color: white; font-size: 1.5rem; }
    </style>
</head>
<body>

<div id="loading-overlay">Đang gửi dữ liệu...</div>

<!-- START SCREEN -->
<div id="start-screen" class="screen active container" style="text-align: center; margin-top: 80px;">
    <div class="card" style="border-top: 5px solid var(--primary);">
        <h1 style="color: var(--primary);">ĐỀ THI CÔNG NGHỆ 7</h1>
        <p>HKI - Thời gian: 45 phút</p>
        <div style="text-align: left; margin: 20px 0;">
            <label>Họ và tên:</label> <input type="text" id="s-name" placeholder="Nhập họ tên..." style="width: 100%; padding: 10px; margin-bottom: 10px;">
            <label>Lớp:</label> <input type="text" id="s-class" placeholder="Nhập lớp..." style="width: 100%; padding: 10px;">
        </div>
        <button class="btn" style="width: 100%;" onclick="startQuiz()">BẮT ĐẦU LÀM BÀI</button>
    </div>
</div>

<!-- QUIZ SCREEN -->
<div id="quiz-screen" class="screen">
    <div class="header">
        <div id="info-display" style="font-weight:bold;">Học sinh</div>
        <div class="timer" id="timer">45:00</div>
        <button class="btn" onclick="confirmSubmit()">Nộp bài</button>
    </div>
    <div class="container" style="margin-top: 80px;" id="questions-list"></div>
</div>

<!-- RESULT SCREEN -->
<div id="result-screen" class="screen container">
    <div class="card">
        <h2>KẾT QUẢ</h2>
        <h1 id="final-score"></h1>
        <p>Điểm trắc nghiệm (Thang 10)</p>
        <div id="submit-status" style="margin: 15px 0; font-weight: bold;"></div>
        <button id="btn-send-sheet" class="btn" onclick="sendToGoogleSheet()">Gửi kết quả cho Giáo viên</button>
        <button class="btn" style="background: #64748b; margin-left: 10px;" onclick="location.reload()">Làm lại</button>
    </div>
    <div id="review-list" style="text-align: left;"></div>
</div>

<!-- IMPORT APP.JS (Lùi ra 1 cấp thư mục) -->
<script src="../app.js"></script>

<script>
    const questions = [
        // 12 câu trắc nghiệm (3 điểm)
        { id: 1, type: 'mc', q: "Giâm cành là phương pháp nhân giống:", opts: ["Hữu tính", "Vô tính", "Nuôi cấy mô", "Lai tạo"], a: 1 },
        { id: 2, type: 'mc', q: "Cây nào dễ giâm cành?", opts: ["Lúa", "Ngô", "Mía", "Xoài"], a: 2 },
        { id: 3, type: 'mc', q: "Chiều dài tiêu chuẩn cành giâm?", opts: ["5-10cm", "15-20cm", "30-40cm", "50cm"], a: 1 },
        { id: 4, type: 'mc', q: "Quy trình giâm cành có mấy bước?", opts: ["3", "4", "5", "6"], a: 1 },
        { id: 5, type: 'mc', q: "Đất trồng cải xanh cần:", opts: ["Nén chặt", "Ngập nước", "Tơi xốp", "Nhiều đá"], a: 2 },
        { id: 6, type: 'mc', q: "Thời gian thu hoạch cải xanh?", opts: ["15-20 ngày", "30-40 ngày", "60 ngày", "3 tháng"], a: 1 },
        { id: 7, type: 'mc', q: "Nên tưới rau vào lúc nào?", opts: ["Trưa nắng", "Sáng sớm/Chiều mát", "Đêm khuya", "Lúc nào cũng được"], a: 1 },
        { id: 8, type: 'mc', q: "Vai trò rừng phòng hộ?", opts: ["Lấy gỗ", "Du lịch", "Chắn gió, chống xói mòn", "Nghiên cứu"], a: 2 },
        { id: 9, type: 'mc', q: "Rừng đặc dụng dùng để:", opts: ["Bảo tồn thiên nhiên", "Khai thác gỗ", "Chắn cát", "Làm nương rẫy"], a: 0 },
        { id: 10, type: 'mc', q: "Rừng sản xuất dùng để:", opts: ["Nghiên cứu", "Khai thác gỗ, lâm sản", "Chắn sóng", "Bảo tồn gene"], a: 1 },
        { id: 11, type: 'mc', q: "Vườn quốc gia Cúc Phương là:", opts: ["Rừng sản xuất", "Rừng đặc dụng", "Rừng phòng hộ", "Rừng ngập mặn"], a: 1 },
        { id: 12, type: 'mc', q: "Khi phun thuốc trừ sâu cần:", opts: ["Phun ngược gió", "Không đeo khẩu trang", "Phun theo chiều gió", "Phun buổi trưa"], a: 2 }
        // (Lược bớt các câu tự luận/điền khuyết để gọn code, bạn có thể copy từ file cũ vào đây nếu cần)
    ];

    let answers = {};
    let timeLeft = 45 * 60;
    let timerId;

    function startQuiz() {
        const name = document.getElementById('s-name').value;
        const cls = document.getElementById('s-class').value;
        if (!name || !cls) return alert("Vui lòng nhập tên và lớp!");
        document.getElementById('info-display').innerText = `${name} - ${cls}`;
        document.getElementById('start-screen').classList.remove('active');
        document.getElementById('quiz-screen').classList.add('active');
        renderQuestions();
        timerId = setInterval(() => {
            timeLeft--;
            const m = Math.floor(timeLeft/60);
            const s = timeLeft%60;
            document.getElementById('timer').innerText = `${m}:${s<10?'0':''}${s}`;
            if(timeLeft<=0) submitQuiz();
        }, 1000);
    }

    function renderQuestions() {
        const list = document.getElementById('questions-list');
        questions.forEach((q, idx) => {
            let html = `<div class="card"><span class="badge">Câu ${idx+1}</span><h3>${q.q}</h3>`;
            if (q.type === 'mc') {
                q.opts.forEach((opt, oIdx) => {
                    html += `<button class="option-btn" onclick="selectMC(${q.id}, ${oIdx}, this)">${String.fromCharCode(65+oIdx)}. ${opt}</button>`;
                });
            }
            html += `</div>`;
            list.innerHTML += html;
        });
    }

    function selectMC(qid, optIdx, btn) {
        answers[qid] = optIdx;
        const parent = btn.parentElement;
        parent.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
    }

    function confirmSubmit() { if (confirm("Nộp bài?")) submitQuiz(); }

    function submitQuiz() {
        clearInterval(timerId);
        document.getElementById('quiz-screen').classList.remove('active');
        document.getElementById('result-screen').classList.add('active');
        
        let score = 0;
        let detailText = "";
        
        questions.forEach((q, idx) => {
            detailText += `Câu ${idx+1}: `;
            if (q.type === 'mc') {
                const isCorrect = answers[q.id] === q.a;
                if (isCorrect) score += 0.25; // 12 câu = 3đ
                detailText += isCorrect ? "Đúng" : "Sai";
            }
            detailText += " | ";
        });
        
        // Giả lập điểm (bạn có thể chỉnh lại thang điểm nếu thêm câu hỏi)
        // Hiện tại chỉ có 12 câu MC * 0.25 = 3đ tối đa. Tôi nhân lên hệ số để ra thang 10 demo.
        const finalScore = (score * (10/3)).toFixed(2); 
        
        document.getElementById('final-score').innerText = finalScore;

        // CHUẨN BỊ DỮ LIỆU ĐỂ GỬI QUA APP.JS
        window.examData = {
            timestamp: new Date().toLocaleString('vi-VN'),
            name: document.getElementById('s-name').value,
            class: document.getElementById('s-class').value,
            score: finalScore,
            detail: detailText
        };
    }
</script>
</body>
</html>
