<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đề Kiểm Tra Công Nghệ 7 - HCMUS Style</title>
    <style>
        /* --- CẤU HÌNH GIAO DIỆN (THEO STYLE TRONG PDF) --- */
        :root {
            --primary: #005a8d; /* Xanh đậm HCMUS */
            --primary-dark: #00406b;
            --accent: #f39c12; /* Màu cam nhấn */
            --bg: #f8f9fa;     /* Nền sáng */
            --white: #ffffff;
            --text: #333333;
            --border: #dddddd;
            --blue: #2563eb;
            --red: #dc2626;
            --success: #22c55e;
            --light-blue: #e0f2fe;
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: var(--bg); 
            color: var(--text); 
            margin: 0; 
            padding-bottom: 80px; 
            line-height: 1.6;
        }

        .container { max-width: 900px; margin: 0 auto; padding: 20px; }
        
        /* Screens */
        .screen { display: none; animation: fadeIn 0.4s; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Card Style */
        .card { 
            background: var(--white); 
            border-radius: 8px; 
            padding: 25px; 
            margin-bottom: 20px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); 
            border: 1px solid var(--border); 
        }
        .card h3 { margin-top: 0; font-size: 1.15rem; color: var(--primary); font-weight: 600; }
        
        .badge { 
            display: inline-block; 
            font-size: 0.8rem; 
            font-weight: 700; 
            color: var(--white); 
            background: var(--accent);
            padding: 3px 10px; 
            border-radius: 4px; 
            margin-bottom: 10px; 
        }

        /* Inputs & Buttons */
        input[type="text"], textarea { 
            width: 100%; padding: 12px; margin: 8px 0 20px; 
            border: 2px solid var(--border); border-radius: 6px; 
            box-sizing: border-box; transition: border-color 0.3s;
        }
        input[type="text"]:focus, textarea:focus { border-color: var(--primary); outline: none; }

        button.btn { 
            background-color: var(--primary); color: white; padding: 12px 24px; 
            border: none; border-radius: 6px; font-weight: 700; cursor: pointer; 
            width: 100%; font-size: 1rem; transition: all 0.2s; text-transform: uppercase;
        }
        button.btn:hover { background-color: var(--primary-dark); transform: translateY(-1px); }
        button.btn:disabled { background-color: #9ca3af; cursor: not-allowed; transform: none; }

        /* Question Styles */
        .option-btn { 
            display: block; width: 100%; text-align: left; padding: 14px; 
            border: 2px solid var(--border); border-radius: 8px; background: white; 
            margin-bottom: 10px; cursor: pointer; transition: 0.2s; font-size: 0.95rem;
        }
        .option-btn:hover { background: #f1f5f9; border-color: var(--primary); }
        .option-btn.selected { background: var(--light-blue); border-color: var(--primary); color: var(--primary); font-weight: 600; }
        .option-btn.correct { background: #dcfce7; border-color: var(--success); color: #166534; }
        .option-btn.wrong { background: #fee2e2; border-color: var(--red); color: #991b1b; }

        /* True/False Group */
        .tf-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .tf-table th, .tf-table td { border: 1px solid var(--border); padding: 12px; text-align: left; }
        .tf-table th { background: #f8fafc; text-align: center; color: #555; }
        .tf-btn { width: 70px; padding: 6px; border-radius: 4px; border: 1px solid #ccc; cursor: pointer; font-weight: 600; }
        .tf-btn.selected { background: var(--primary); color: white; border-color: var(--primary); }

        /* Drag & Drop */
        .fill-area { 
            line-height: 2.2; font-size: 1.1rem; background: var(--light-blue); 
            padding: 20px; border-radius: 8px; border: 2px dashed var(--primary); margin-bottom: 15px; 
        }
        .drop-slot { 
            display: inline-block; min-width: 100px; height: 30px; 
            border-bottom: 2px solid var(--primary); text-align: center; color: var(--primary); 
            font-weight: bold; margin: 0 5px; cursor: pointer; background: white; 
            vertical-align: bottom; border-radius: 4px;
        }
        .word-bank { display: flex; flex-wrap: wrap; gap: 10px; }
        .word-item { 
            padding: 8px 16px; background: white; border: 1px solid var(--border);
            border-radius: 20px; cursor: pointer; font-size: 0.9rem; user-select: none; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: transform 0.2s;
        }
        .word-item:hover { transform: translateY(-2px); border-color: var(--primary); }
        .word-item.used { opacity: 0.5; pointer-events: none; background: #e5e7eb; transform: none; box-shadow: none; }

        /* Sticky Header */
        .header { 
            position: fixed; top: 0; left: 0; right: 0; background: white; 
            padding: 10px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 100; 
            display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 3px solid var(--primary);
        }
        .header-logo { font-weight: 800; font-size: 1.2rem; color: var(--primary); text-transform: uppercase; }
        .timer { font-weight: 800; color: white; background: var(--accent); padding: 5px 15px; border-radius: 20px; font-family: monospace; font-size: 1.1rem; }

        /* Modal */
        #loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 200; text-align: center; padding-top: 20%; color: white; font-size: 1.5rem; font-weight: bold; }
    </style>
</head>
<body>

<!-- LOADING OVERLAY -->
<div id="loading-overlay">Đang gửi dữ liệu lên hệ thống...</div>

<!-- START SCREEN -->
<div id="start-screen" class="screen active container" style="text-align: center; margin-top: 80px;">
    <div class="card" style="border-top: 5px solid var(--primary);">
        <h1 style="color: var(--primary); margin-bottom: 5px;">HỆ THỐNG KIỂM TRA TRỰC TUYẾN</h1>
        <h2 style="color: #666; font-weight: 500; margin-top: 0;">Môn: Công Nghệ 7</h2>
        <p class="badge" style="font-size: 1rem; padding: 5px 15px;">HKI - Thời gian: 45 phút</p>
        
        <div style="text-align: left; margin-top: 30px;">
            <label style="font-weight: 600; color: var(--text);">Họ và tên học sinh:</label>
            <input type="text" id="s-name" placeholder="Nhập họ và tên đầy đủ...">
            
            <label style="font-weight: 600; color: var(--text);">Lớp:</label>
            <input type="text" id="s-class" placeholder="VD: 7A1...">
        </div>
        <button class="btn" onclick="startQuiz()">BẮT ĐẦU LÀM BÀI</button>
    </div>
    <p style="color: #999; font-size: 0.9rem;">Hệ thống bài tập theo phong cách HCMUS</p>
</div>

<!-- QUIZ SCREEN -->
<div id="quiz-screen" class="screen">
    <div class="header">
        <div class="header-logo">Công Nghệ 7</div>
        <div id="info-display" style="font-weight:600; font-size: 0.9rem; color: #555;">Học sinh</div>
        <div class="timer" id="timer">45:00</div>
        <button onclick="confirmSubmit()" style="background:var(--primary); color:white; border:none; padding:8px 20px; border-radius:20px; cursor:pointer; font-weight:bold; font-size: 0.9rem;">NỘP BÀI</button>
    </div>
    <div class="container" style="margin-top: 80px;" id="questions-list"></div>
</div>

<!-- RESULT SCREEN -->
<div id="result-screen" class="screen container" style="text-align: center; margin-top: 50px;">
    <div class="card" style="border-top: 5px solid var(--accent);">
        <h2 style="color: var(--text);">KẾT QUẢ BÀI LÀM</h2>
        <div style="width: 120px; height: 120px; background: var(--light-blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto; border: 4px solid var(--primary);">
            <h1 id="final-score" style="font-size: 2.5rem; margin: 0; color: var(--primary);"></h1>
        </div>
        
        <p style="margin-top: 15px; font-weight: 500;">Điểm trắc nghiệm & điền khuyết (Thang 10)</p>
        <p style="font-size: 0.9rem; color: gray; font-style: italic;">(Phần tự luận sẽ được giáo viên chấm sau)</p>
        
        <!-- Thông báo gửi thành công -->
        <div id="submit-status" style="margin-top: 20px; padding: 15px; background: #dcfce7; color: #166534; border-radius: 8px; border: 1px solid #86efac; display: none; font-weight: 600;">
            ✅ Đã lưu kết quả vào hệ thống thành công!
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <!-- Nút gửi gọi hàm từ app.js -->
            <button id="btn-send-sheet" class="btn" style="background: var(--primary);" onclick="sendToGoogleSheet()">Gửi kết quả cho Giáo viên</button>
            <button class="btn" style="background: #64748b;" onclick="location.reload()">Làm lại bài</button>
        </div>
    </div>
    <div id="review-list" style="text-align: left;"></div>
</div>

<!-- !!! QUAN TRỌNG: LIÊN KẾT TỚI APP.JS !!! -->
<!-- Nếu file này nằm trong thư mục con, dùng "../app.js". Nếu ở gốc dùng "app.js" -->
<script src="../app.js"></script>

<script>
    // --- CẤU TRÚC ĐỀ THI ---
    const questions = [
        // 12 CÂU TRẮC NGHIỆM
        { id: 1, type: 'mc', q: "Giâm cành là phương pháp nhân giống:", opts: ["Hữu tính", "Vô tính", "Nuôi cấy mô", "Lai tạo"], a: 1 },
        { id: 2, type: 'mc', q: "Cây nào dễ giâm cành?", opts: ["Lúa", "Ngô", "Mía", "Xoài"], a: 2 },
        { id: 3, type: 'mc', q: "Chiều dài tiêu chuẩn cành giâm?", opts: ["5-10cm", "15-20cm", "30-40cm", "50cm"], a: 1 },
        { id: 4, type: 'mc', q: "Quy trình giâm cành có mấy bước?", opts: ["3", "4", "5", "6"], a: 1 },
        { id: 5, type: 'mc', q: "Đất trồng cải xanh cần:", opts: ["Nén chặt", "Ngập nước", "Tơi xốp", "Nhiều đá"], a: 2 },
        { id: 6, type: 'mc', q: "Thời gian thu hoạch cải xanh?", opts: ["15-20 ngày", "30-40 ngày", "60 ngày", "3 tháng"], a: 1 },
        { id: 7, type: 'mc', q: "Nên tưới rau vào lúc nào?", opts: ["Trưa nắng", "Sáng sớm/Chiều mát", "Đêm khuya", "Lúc nào cũng được"], a: 1 },
        { id: 8, type: 'mc', q: "Vai trò rừng phòng hộ?", opts: ["Lấy gỗ", "Du lịch", "Chắn gió, chống xói mòn", "Nghiên cứu"], a: 2 },
        { id: 9, type: 'mc', q: "Rừng đặc dụng dùng để:", opts: ["Bảo tồn thiên nhiên", "Khai thác gỗ", "Chắn cát", "Làm nương rẫy"], a: 0 },
        { id: 10, type: 'mc', q: "Rừng sản xuất dùng để:", opts: ["Nghiên cứu", "Khai thác gỗ, lâm sản", "Chắn sóng", "Bảo tồn gene"], a: 1 },
        { id: 11, type: 'mc', q: "Vườn quốc gia Cúc Phương là:", opts: ["Rừng sản xuất", "Rừng đặc dụng", "Rừng phòng hộ", "Rừng ngập mặn"], a: 1 },
        { id: 12, type: 'mc', q: "Khi phun thuốc trừ sâu cần:", opts: ["Phun ngược gió", "Không đeo khẩu trang", "Phun theo chiều gió", "Phun buổi trưa"], a: 2 },

        // 4 CÂU ĐÚNG SAI
        { 
            id: 13, type: 'tf-group', q: "Nhận định về phương pháp giâm cành:", 
            items: [
                { t: "Là phương pháp nhân giống hữu tính.", a: false },
                { t: "Cây con giữ được đặc tính của cây mẹ.", a: true },
                { t: "Hệ số nhân giống thấp, lâu thu hoạch.", a: false },
                { t: "Mía, sắn, rau ngót dễ giâm cành.", a: true }
            ]
        },
        { 
            id: 14, type: 'tf-group', q: "Quy trình trồng rau cải xanh an toàn:", 
            items: [
                { t: "Nên dùng nhiều phân bón hóa học để cây lớn nhanh.", a: false },
                { t: "Ưu tiên sử dụng phân hữu cơ, vi sinh.", a: true },
                { t: "Tưới nước bất cứ khi nào rảnh.", a: false },
                { t: "Ngưng phun thuốc hóa học trước khi thu hoạch theo quy định.", a: true }
            ]
        },
        { 
            id: 15, type: 'tf-group', q: "Vai trò của rừng:", 
            items: [
                { t: "Cung cấp Oxy, thu nhận CO2.", a: true },
                { t: "Làm tăng nguy cơ lũ lụt.", a: false },
                { t: "Chống xói mòn, rửa trôi đất.", a: true },
                { t: "Là nơi sinh sống của động thực vật.", a: true }
            ]
        },
        { 
            id: 16, type: 'tf-group', q: "Phân loại rừng ở Việt Nam:", 
            items: [
                { t: "Rừng tràm là phân loại theo nguồn gốc.", a: false },
                { t: "Rừng nguyên sinh là phân loại theo nguồn gốc.", a: true },
                { t: "Rừng phòng hộ dùng để khai thác gỗ xuất khẩu.", a: false },
                { t: "Rừng ngập mặn phân bố ở vùng ven biển.", a: true }
            ]
        },

        // 5 CÂU ĐIỀN KHUYẾT
        { 
            id: 17, type: 'fill', q: "Quy trình giâm cành: Tạo giá thể → Tạo lỗ → ...1... → Tỉa bớt lá → Giâm vào giá thể.", 
            bank: ["Cắt cành", "Tưới nước", "Bón phân", "Phơi nắng"], a: ["Cắt cành"] 
        },
        { 
            id: 18, type: 'fill', q: "Rừng là nơi sinh sống của thực vật, ...1... và vi sinh vật.", 
            bank: ["con người", "động vật", "cá", "nhà cửa"], a: ["động vật"] 
        },
        { 
            id: 19, type: 'fill', q: "Cần chọn cành giâm ở giai đoạn ...1..., không quá non, không quá già.", 
            bank: ["ra hoa", "ổn định", "mới mọc", "khô héo"], a: ["ổn định"] 
        },
        { 
            id: 20, type: 'fill', q: "Để cải tạo đất phèn, người ta thường bón ...1...", 
            bank: ["đạm", "vôi", "nước", "lân"], a: ["vôi"] 
        },
        { 
            id: 21, type: 'fill', q: "Rừng ...1... giúp chắn gió, bão, chống cát bay.", 
            bank: ["sản xuất", "phòng hộ", "đặc dụng", "nguyên sinh"], a: ["phòng hộ"] 
        },

        // 5 CÂU TỰ LUẬN
        { id: 22, type: 'short', q: "Tại sao phải tỉa bớt lá khi giâm cành?" },
        { id: 23, type: 'short', q: "Kể tên 3 dụng cụ trồng rau?" },
        { id: 24, type: 'short', q: "Thế nào là canh tác hữu cơ?" },
        { id: 25, type: 'short', q: "Nêu 2 ví dụ về rừng đặc dụng ở Việt Nam." },
        { id: 26, type: 'short', q: "Em làm gì để bảo vệ rừng?" }
    ];

    let answers = {};
    let timeLeft = 45 * 60;
    let timerId;

    // --- LOGIC ---
    function startQuiz() {
        const name = document.getElementById('s-name').value;
        const cls = document.getElementById('s-class').value;
        if (!name || !cls) return alert("Vui lòng nhập tên và lớp!");

        document.getElementById('info-display').innerText = `${name} - ${cls}`;
        document.getElementById('start-screen').classList.remove('active');
        document.getElementById('quiz-screen').classList.add('active');
        
        renderQuestions();
        timerId = setInterval(() => {
            timeLeft--;
            const m = Math.floor(timeLeft/60);
            const s = timeLeft%60;
            document.getElementById('timer').innerText = `${m}:${s<10?'0':''}${s}`;
            if(timeLeft<=0) submitQuiz();
        }, 1000);
    }

    function renderQuestions() {
        const list = document.getElementById('questions-list');
        questions.forEach((q, idx) => {
            let html = `<div class="card">
                <span class="badge">Câu ${idx+1}</span>
                <h3>${q.q}</h3>`;

            if (q.type === 'mc') {
                q.opts.forEach((opt, oIdx) => {
                    html += `<button class="option-btn" onclick="selectMC(${q.id}, ${oIdx}, this)">${String.fromCharCode(65+oIdx)}. ${opt}</button>`;
                });
            }
            else if (q.type === 'tf-group') {
                html += `<table class="tf-table">
                    <tr><th>Nội dung</th><th>Đúng</th><th>Sai</th></tr>`;
                q.items.forEach((item, iIdx) => {
                    html += `<tr>
                        <td>${item.t}</td>
                        <td style="text-align:center"><button class="tf-btn" onclick="selectTF(${q.id}, ${iIdx}, true, this)">Đ</button></td>
                        <td style="text-align:center"><button class="tf-btn" onclick="selectTF(${q.id}, ${iIdx}, false, this)">S</button></td>
                    </tr>`;
                });
                html += `</table>`;
            }
            else if (q.type === 'fill') {
                const parts = q.q.split('...1...');
                html += `<div class="fill-area">${parts[0]} <span class="drop-slot" onclick="clearSlot(${q.id})" id="slot-${q.id}">...</span> ${parts[1]}</div>`;
                html += `<div class="word-bank">`;
                q.bank.forEach(w => {
                    html += `<span class="word-item" onclick="fillSlot(${q.id}, '${w}', this)">${w}</span>`;
                });
                html += `</div>`;
            }
            else if (q.type === 'short') {
                html += `<textarea rows="3" placeholder="Nhập câu trả lời..." onchange="saveShort(${q.id}, this.value)"></textarea>`;
            }

            html += `</div>`;
            list.innerHTML += html;
        });
    }

    // --- INTERACTION ---
    function selectMC(qid, optIdx, btn) {
        answers[qid] = optIdx;
        const parent = btn.parentElement;
        parent.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
    }

    function selectTF(qid, itemIdx, val, btn) {
        if (!answers[qid]) answers[qid] = {};
        answers[qid][itemIdx] = val;
        const row = btn.parentElement.parentElement;
        row.querySelectorAll('.tf-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
    }

    function fillSlot(qid, word, btn) {
        const bank = btn.parentElement;
        bank.querySelectorAll('.word-item').forEach(b => b.classList.remove('used'));
        answers[qid] = word;
        document.getElementById(`slot-${qid}`).innerText = word;
        document.getElementById(`slot-${qid}`).style.color = '#005a8d';
        btn.classList.add('used');
    }

    function clearSlot(qid) {
        delete answers[qid];
        document.getElementById(`slot-${qid}`).innerText = '...';
        document.getElementById(`slot-${qid}`).style.color = 'inherit';
        const bank = document.getElementById(`slot-${qid}`).parentElement.nextElementSibling;
        bank.querySelectorAll('.word-item').forEach(b => b.classList.remove('used'));
    }

    function saveShort(qid, val) {
        answers[qid] = val;
    }

    function confirmSubmit() {
        if (confirm("Em chắc chắn muốn nộp bài?")) submitQuiz();
    }

    function submitQuiz() {
        clearInterval(timerId);
        document.getElementById('quiz-screen').classList.remove('active');
        document.getElementById('result-screen').classList.add('active');

        let score = 0;
        let detailText = ""; 

        questions.forEach((q, idx) => {
            detailText += `Câu ${idx+1}: `;
            if (q.type === 'mc') {
                const isCorrect = answers[q.id] === q.a;
                if (isCorrect) score += 0.25;
                detailText += isCorrect ? "Đúng" : `Sai (Chọn: ${q.opts[answers[q.id]] || 'Chưa làm'})`;
            }
            else if (q.type === 'tf-group') {
                let correctCount = 0;
                let subRes = [];
                q.items.forEach((item, i) => {
                    const userAns = answers[q.id] ? answers[q.id][i] : null;
                    if (userAns === item.a) correctCount++;
                    subRes.push(userAns === item.a ? "Đ" : "S");
                });
                score += correctCount * 0.1;
                detailText += `Đúng ${correctCount}/4 ý (${subRes.join(',')})`;
            }
            else if (q.type === 'fill') {
                const isCorrect = answers[q.id] === q.a[0];
                if (isCorrect) score += 0.4;
                detailText += isCorrect ? "Đúng" : `Sai (Điền: ${answers[q.id] || '...'})`;
            }
            else {
                detailText += `TL: ${answers[q.id] || 'Trống'}`;
            }
            detailText += " | ";
        });

        const finalScore = score.toFixed(2);
        document.getElementById('final-score').innerText = finalScore;
        
        // CHUẨN BỊ DỮ LIỆU ĐỂ GỬI QUA APP.JS
        window.examData = {
            timestamp: new Date().toLocaleString('vi-VN'),
            name: document.getElementById('s-name').value,
            class: document.getElementById('s-class').value,
            score: finalScore,
            detail: detailText
        };
    }
</script>

</body>
</html>
